flow AN_Got_Shovel():
    run Event45()

flow ForMarketBuilding():
    MainNpc.EventFlags['cNpcSave:MarketBuildingSupport'] = true
    switch MainNpc.CheckNpcLook():
        case 3:
            run ForMarketBuilding_AN()
        case 5:
            run ForMarketBuilding_HA()
        default:
            return

flow ForMarketBuilding_AN():
    if System.EventFlags['cLand:RcmShopMaterialComplete']:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:011', false)
        run FromFreeH_AN2()
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:001', false)
        run FromFreeH_AN1()

flow ForMarketBuilding_HA():
    if not System.EventFlags['cLand:RcmShopMaterialComplete']:
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:001', false)
        run FromFreeH_HA1()
    elif System.EventFlags['cPlayer:DecideShopArea']:
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:012', false)
        run FromFreeH_HA2()
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:011', false)
        run FromFreeH_HA1()

flow FromFreeH_AN1():
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:002_01', false)
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:002_02', false)
    if EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') >= 1:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:004_01', true)
        if EventFlowSystemActor.PlayerHasCraftRecipe('DIYbookNormalTools', 65534):
            MainNpc.SetDeliveryItemAtRandom(5856, true, 'cRemakePattern0', 0)
            MainNpc.NpcDelivery(1, 'Keep')
            MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:004_03', true)
        else:
entrypoint Event45:
            MainNpc.SetDeliveryItemAtRandom(2099, true, 'cRemakePattern0', 0)
            MainNpc.NpcDelivery(1, 'Keep')
            MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:004_02', true)
        MainNpc.NpcDelivery(2, 'Default')
    elif not EventFlowSystemActor.PlayerHasCraftRecipe('DIYbookNormalTools', 65534):
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:003_01', false)
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:003_02', false)

flow FromFreeH_AN2():
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:002_01', false)
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:002_02', false)
    if EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') >= 1:
        MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:012_01', false)
        if EventFlowSystemActor.PlayerHasCraftRecipe('DIYbookNormalTools', 65534):
            MainNpc.SetDeliveryItemAtRandom(5856, true, 'cRemakePattern0', 0)
            MainNpc.NpcDelivery(1, 'Keep')
            MainNpc.OpenMessageWindow('TalkNNpc/G4_An/Approach/AN_ApproachE_MainSeq:012_02', true)
            MainNpc.NpcDelivery(2, 'Default')
        else:
            run AN_Got_Shovel()

flow FromFreeH_HA1():
    if EventFlowSystemActor.ShoppingCapacity('cItemName', 2511):
        MainNpc.SetDeliveryItemAtRandom(2511, false, 'cVillageRemakePattern', 0)
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:002_02', true)
        MainNpc.NpcDelivery(1, 'Keep')
        if EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') < 1:
            MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:003_02', true)
            EventFlowSystemActor.SetItemToPocket(2511, 1)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:003_01', true)
            EventFlowSystemActor.SetItemToPocket(2511, 5)
        MainNpc.NpcDelivery(2, 'Default')
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:002_01', false)

flow FromFreeH_HA2():
    if EventFlowSystemActor.ShoppingCapacity('cItemName', 2511):
        MainNpc.SetDeliveryItemAtRandom(2511, false, 'cVillageRemakePattern', 0)
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:013_02', false)
        MainNpc.NpcDelivery(1, 'Keep')
        if EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') < 1:
            MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:014_02', true)
            EventFlowSystemActor.SetItemToPocket(2511, 1)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:014_01', true)
            EventFlowSystemActor.SetItemToPocket(2511, 5)
        MainNpc.NpcDelivery(2, 'Default')
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B2_Ha/Approach/HA_ApproachE_MainSeq:013_01', false)

