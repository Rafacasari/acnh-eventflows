flow Begin():
    switch MainNpc.NpcTreasureQuestDifficulty():
        case 0, 1:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:001', false)
                    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                        run TreasurePlay()
                    else:
                        run TreasureNoPlay()
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:002', false)
                    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                        run TreasurePlay()
                    else:
                        run TreasureNoPlay()
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:003', false)
                    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                        run TreasurePlay()
                    else:
                        run TreasureNoPlay()

flow Begin_Ap():
    if MainNpc.CheckNpcApproachType():
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:101', false)
        if EventFlowSystemActor.GeneralTalkChoice2() != 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:105', false)
            MainNpc.NpcQuestControl('cFinish')
        elif EventFlowSystemActor.EnvHourCompare(0, -1, true, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:104', true)
            MainNpc.EventFlags['cNpcMemory:ApproachQuestOrdered'] = true
            run SetPlaza()
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:103', true)
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:102', false)
        if EventFlowSystemActor.GeneralTalkChoice2() != 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:108', false)
            MainNpc.NpcQuestControl('cFinish')
        elif EventFlowSystemActor.EnvHourCompare(0, -1, true, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:107', true)
            MainNpc.EventFlags['cNpcMemory:ApproachQuestOrdered'] = true
            run SetPlaza()
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:106', true)

flow SetPlaza():
    EventFlowSystemActor.FadeOut('cCircle', 'cCircle', 'cBlack', 1.0, 1.0, true)
    if MainNpc.CheckNpcTool() in (0, 1, 2, 3, 4):
        MainNpc.NpcChangeHandTool(65534, 'cNone', true)
    MainNpc.NpcTreasureQuestSetting()
    EventFlowSystemActor.WaitFrame(60)
    EventFlowSystemActor.FadeIn(true)
    if MainNpc.NpcTreasureBurySuccess():
        if System.EventFlags['cPlayer:HasPlayedTreasureHunt']:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:013', true)
            if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                if EventFlowSystemActor.IsSharePlay(0):
                    if MainNpc.NpcTreasureQuestDifficulty() == 0:
                        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:011_01', true)
                    else:
                        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:012_01', true)
                elif MainNpc.NpcTreasureQuestDifficulty() == 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:011', true)
                else:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:012', true)
            elif EventFlowSystemActor.IsSharePlay(0):
                if MainNpc.NpcTreasureQuestDifficulty() == 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:014_01', true)
                else:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:015_01', true)
            elif MainNpc.NpcTreasureQuestDifficulty() == 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:014', true)
            else:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:015', true)
        else:
            if EventFlowSystemActor.IsSharePlay(0):
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:011_01', true)
            else:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:011', true)
        EventFlowSystemActor.BGMPropertyControl(11)
        MainNpc.NpcQuestControl('cStart')
        MainNpc.EventFlags['cNpcMemory:OrderQuest'] = true
        System.EventFlags['cPlayer:TreasurePlayerWin'] = false
        EventFlowSystemActor.CameraSetDemoParam('cNormal', 'cDefault', '', false, false, false, 0)
        EventFlowSystemActor.SetSharePlayChangeCondition(true)
        EventFlowSystemActor.SetSharePlaySubToolCondition(false)
        if MainNpc.NpcTreasureQuestDifficulty() == 0:
            EventFlowSystemActor.UIMiniGameTimerAppear(360, 'cNone')
        else:
            EventFlowSystemActor.UIMiniGameTimerAppear(180, 'cNone')
        MainNpc.CharacterEmoticonAction('FaintSmile', true, '', 0, false)
        EventFlowSystemActor.WaitFrame(60)
        MainNpc.AdjustTreasureLimit()
        MainNpc.AddMemoryEventPlayerForNpc('NNPC_PlayWith')
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:200', false)
        MainNpc.NpcQuestControl('cFinish')

flow TreasureNoPlay():
    switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
        case 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:008', false)
        case 1:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:009', false)
        case 2:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:010', false)
    MainNpc.NpcQuestControl('cFinish')

flow TreasurePlay():
    if EventFlowSystemActor.EnvHourCompare(0, -1, true, true) == 0:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:004', true)
                run SetPlaza()
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:005', true)
                run SetPlaza()
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:006', true)
                run SetPlaza()
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Begin:007', false)
        MainNpc.NpcQuestControl('cFinish')

