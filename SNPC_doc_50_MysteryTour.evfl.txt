flow CloseUI():
    fork:
        branch:
            EventFlowSystemActor.UISonkatsuPointDisappear()
        branch:
            EventFlowSystemActor@UI.UIShopBuyDisappear()

flow DocCmnCancel():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:008', false)

flow ExchangeCancel():
    run CloseUI()
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:013', false)

flow FaintEntry():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:021', false)
    System.EventFlags['cPlayerTemp:DodTalkSceneFlag'] = true

flow Root():
    System.EventFlags['cPlayer:RcoMachineExplainAboutPlaneTicket'] = true
    if EventFlowSystemActor.SystemCheckNowStage('cCheckStageSymbol01'):
        run SNPC_doc_54_MayDayTour::Root()
    elif System.EventFlags['cPlayerTemp:DodTalkSceneFlag']:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:002', false)
        switch EventFlowSystemActor.GeneralTalkChoice3():
            case 0:
                MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:003', false)
                if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:004', true)
                    EventFlowSystemActor.BGMPropertyControl(76)
                    EventFlowSystemActor.SoundTriggerEmit('Airplane_Takeoff_Short', -1)
                    System.EventFlags['cLandTemp:DocReturnFromIsland'] = true
                    EventFlowSystemActor.SystemRequestChangeStage('cFromOutlierToHomeland', 'cDALWithLoadWait', 'cCircle', 'cBlack', 1.0, 1.0)
                else:
                    run DocCmnCancel()
            case 1:
                if EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') < 1:
                    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:012', true)
                else:
                    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:011', false)
                    fork:
                        branch:
                            EventFlowSystemActor.UISonkatsuPointAppear()
                        branch:
                            EventFlowSystemActor@UI.UIShopBuyAppear('cRodly')
                    if EventFlowSystemActor.UIResultMenuDecide():
                        EventFlowSystemActor.SetTagFromUIResult('cItemName', 0)
                        EventFlowSystemActor.SetTagFromSystem('cFlow', 'cDegit', 0, 100, '')
                        if EventFlowSystemActor.HasLifeSupportPoint(100, 'Now'):
                            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:015', false)
                            if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                                EventFlowSystemActor.LifeSupportPointCountDown(-100, false)
                                run CloseUI()
                                MainNpc.SetDeliveryItem(4, false)
                                MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:016', true)
                                MainNpc.NpcDelivery(1, 'Default')
                                EventFlowSystemActor.SetTagFromUIResult('cItemName', 0)
                                MainNpc.ShopBuyDone(false, false, false, false)
                                MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:017', false)
                            else:
                                run ExchangeCancel()
                        else:
                            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:014', false)
                            run CloseUI()
                    else:
                        run ExchangeCancel()
            case 2:
                run DocCmnCancel()
    else:
        System.EventFlags['cPlayerTemp:DodTalkSceneFlag'] = true
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:001_01', false)
        if not System.EventFlags['cPlayer:DocMysterytourExplain1st']:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:001_02', false)
            System.EventFlags['cPlayer:DocMysterytourExplain1st'] = true
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_51_MysteryTour:001_03', false)

flow Root_Init():
    if MainNpc.NpcBlackBoard('SceneReenter', 1):
        System.EventFlags['cPlayerTemp:DodTalkSceneFlag'] = true

