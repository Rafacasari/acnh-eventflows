flow FirstSelectExtention():
    if not System.EventFlags['cWherearenPlayer:SeqFirstSelectExtentionDone']:
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:113_01', true)
        System.EventFlags['cWherearenPlayer:SeqFirstSelectExtentionDone'] = true

flow LocationTutorial():
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:621', true)
    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_WherearenEvent_Once:031', true)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:621_01', false)
    MainNpc.TurnNeck(10, true)
    EventFlowSystemActor.WaitFrame(12)
    Player.TurnNeck(1, false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:622', true)
    Player.TurnNeck(11, true)
    EventFlowSystemActor.WaitFrame(10)
    run SelectField()
    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_WherearenEvent_Once:032', true)
    MainNpc.TurnNeck(1, true)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:623', false)
    MainNpc.TurnNeck(10, true)
    EventFlowSystemActor.WaitFrame(12)
    Player.TurnNeck(1, false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:624', true)
    System.EventFlags['cWherearenPlayer:SeqLocationTutorialDone'] = true
    run NewHouseOrderEnd()

flow MoveHouse():
    EventFlowSystemActor.SetWherearenPlayerRemoveBinderSeq(false, true)
    SubNpc.SetNpcName(0, 0)
    if SubNpc.WherearenIsNpcLiveTogether():
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:201_01', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:201', false)
    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:003_04', false)
    MainNpc.TurnNeck(10, false)
    if SubNpc.WherearenIsNpcLiveTogether():
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:202_01', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:202', false)
    run SelectField()
    run PostSelectField()

flow NPC_CloseEmotion():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.CameraSetDemoParam('OrderCut1', 'OrderCameraRP', '', false, false, false, 0)
    EventFlowSystemActor.WaitFrame(30)
    fork:
        branch:
            run NPC_CloseEmotion_Player()
        branch:
            run NPC_CloseEmotion_Officer()
        branch:
            run NPC_CloseEmotion_Customer()
        branch:
            run NPC_CloseEmotion_MncOrHousemate()
    EventFlowSystemActor.WaitFrame(60)

flow NPC_CloseEmotion_Customer():
    if SubNpc.CheckNpcLook() in (0, 1, 4, 6):
        SubNpc.CharacterEmoticonAction('Clapping', true, '', 0, false)
    else:
        SubNpc.CharacterEmoticonAction('Smiling', true, '', 0, false)

flow NPC_CloseEmotion_MncOrHousemate():
    switch EventFlowSystemActor.WherearenNpcOrderType():
        case 1:
            run Sub_grp_Event110()
        case 3:
            if SubNpc.WherearenIsNpcLiveTogether():
                run Sub_grp_Event110()
        default:
            return

flow NPC_CloseEmotion_Officer():
    MainNpc.TurnNeck(10, false)
    MainNpc.CharacterEmoticonAction('Smiling', true, '', 0, false)

flow NPC_CloseEmotion_Player():
    EventFlowSystemActor.SoundDuckingOn(62)
    EventFlowSystemActor.SoundTriggerEmit('Demo_RequestOkay', -1)
    Player.CharacterEmoticonAction('RequestOkay', true, '', 0, false)
    EventFlowSystemActor.SoundDuckingOff(62)

flow NewHouse():
    EventFlowSystemActor.SetWherearenPlayerRemoveBinderSeq(false, true)
    SubNpc.SetNpcWherearenThemeTag(0)
    SubNpc.SetNpcName(0, 0)
    if EventFlowSystemActor.IsFirstWherearenOrderDemo():
        run NewHouseTutorial()
    elif System.EventFlags['cWherearenPlayer:SeqOtgSickOngoing']:
        run SNPC_mnc_03_WherearenOrder::NewHouse_OtgSick()
    else:
        if not EventFlowSystemActor.IsWherearenNpcOrderNewBuildType():
            MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:301', false)
        SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:003_01', false)
        if System.EventFlags['cWherearenPlayer:ProposeNPCHouse']:
            run Sub_Event57()
        else:
            if System.EventFlags['cPlayerTemp:WHEREAREN_CallSNPCAmiibo']:
                System.EventFlags['cPlayerTemp:WHEREAREN_CallSNPCAmiibo'] = false
                run Sub_Event57()
            else:
                SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:003_02', true)
                run ShowOrder()
                MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:110', false)
                if System.EventFlags['cWherearenPlayer:SeqLocationTutorialDone']:
                    MainNpc.TurnNeck(10, true)
                    EventFlowSystemActor.WaitFrame(12)
                    Player.TurnNeck(0, false)
                    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:111', false)
                    run SameLocationRemind()
                    Player.TurnNeck(11, true)
                    EventFlowSystemActor.WaitFrame(10)
                    run Sub_Event66()
                else:
                    run LocationTutorial()

flow NewHouseOrderEnd():
    Player.TurnNeck(1, false)
    System.EventFlags['cPlayerTemp:WHEREAREN_CustomerTalkReserve_Garden'] = true
    run NPC_CloseEmotion()
    EventFlowSystemActor.WherearenOrderCallback('cConfirm')
    run Demo_Common_Wherearen::SetCamera_GardenVisit()
    EventFlowSystemActor.BGMPropertyControl(140)
    EventFlowSystemActor.SetWherearenPlayerRemoveBinderSeq(false, true)
    EventFlowSystemActor.SoundTriggerEmit('WherearenFade_Boat', -1)
    if EventFlowSystemActor.IsSharehouseOrderCustomer():
        EventFlowSystemActor.ReserveEnterGardenPattern(3)
    else:
        EventFlowSystemActor.ReserveEnterGardenPattern(2)
    EventFlowSystemActor.SystemRequestChangeStage('cWherearenNpcGarden', 'cWherearen', 'cWherearen', 'cBlack', 1.0, 1.0)

flow NewHouseTutorial():
    EventFlowSystemActor.SystemBGMVolumeFadeIn(0.0, 0, 0.0)
    SubNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:601', true)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:602', true)
    SubNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:603', true)
    run ShowOrder()
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:604', false)
    MainNpc.TurnNeck(10, true)
    EventFlowSystemActor.WaitFrame(12)
    Player.TurnNeck(0, false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:605', true)
    MainNpc.TurnNeck(1, true)
    EventFlowSystemActor.WaitFrame(12)
    Player.TurnNeck(1, false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:606', true)
    SubNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:607', true)
    EventFlowSystemActor.BGMPropertyControl(141)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:608', true)
    MainNpc.TurnNeck(10, true)
    EventFlowSystemActor.WaitFrame(12)
    Player.TurnNeck(1, false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:609', true)
    Player.TurnNeck(1, false)
    EventFlowSystemActor.SetWherearenNpcGardenIDDirect(32)
    System.EventFlags['cPlayerTemp:WHEREAREN_MncTalkReserve_Garden'] = true
    run NewHouseOrderEnd()

flow NotFade():
    MainNpc.NpcAISetting(9, true)
    Player.TurnNeck(11, false)
    switch EventFlowSystemActor.WherearenNpcOrderType():
        case 0:
            run NewHouse()
        case 3:
            run MoveHouse()
        default:
            return

flow NotFade_Init():
    run Root_Init()

flow PostSelectField():
    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:003_03', true)
    MainNpc.TurnNeck(1, true)
    if System.EventFlags['cWherearenPlayer:Unlock_Extension']:
        switch EventFlowSystemActor.WherearenNpcOrderType():
            case 0, 2:
                MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:113', false)
                run FirstSelectExtention()
                if SubNpc.EventFlags['cWherearenNpcMemory:ApproachOccurringFlag'] < 1:
                    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:003', false)
                else:
                    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:006', false)
                if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:004', false)
                else:
                    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:005', false)
                    Npc_1.WherearenExpandNpcHouse()
                MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:114', false)
                run NewHouseOrderEnd()
            case 3:
                if SubNpc.WherearenIsNpcLiveTogether():
                    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:112_01', true)
                    run NewHouseOrderEnd()
                else:
                    run Sub_Event14()
            default:
                return
    else:
        run Sub_Event14()

flow Root():
    EventFlowSystemActor.SoundDuckingOn(51)
    EventFlowSystemActor.MessageSuspend()
    MainNpc.NpcAISetting(4, false)
    EventFlowSystemActor.CameraSetDemoParam('OrderCut0', '', '', false, false, true, 0)
    MainNpc.TurnNeck(1, false)
    SubNpc.TurnNeck(10, false)
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.SoundDuckingOff(54)
    EventFlowSystemActor.SystemBGMVolumeFadeIn(0.0, 0, 0.0)
    EventFlowSystemActor.BGMPropertyControl(137)
    EventFlowSystemActor.SoundFadeOutDuckingOff()
    EventFlowSystemActor.FadeIn(true)
    run NotFade()

flow Root_Init():
    if EventFlowSystemActor.WherearenNpcOrderType() in (0, 3):
        MainNpc.NpcAISetting(9, false)
        if (System.EventFlags['cWherearenPlayer:SeqOtgSickOngoing']) or (EventFlowSystemActor.WherearenNpcFreeQuery2('otg', 'cCustomer')):
            MainNpc.NpcAITalkCastSetting('WherearenOrder')

flow SameLocationRemind():
    if (System.EventFlags['cWherearenPlayer:NewBuildCount'] == 8) and (not System.EventFlags['cWherearenPlayer:SeqSameLocationRemindDone']):
        MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:191', false)
        System.EventFlags['cWherearenPlayer:SeqSameLocationRemindDone'] = true

flow SelectField():
    Player.PlayerStartLookDown()
    EventFlowSystemActor.SoundDuckingOn(63)
    fork:
        branch:
            EventFlowSystemActor.UIWherearenIslandsMapHandling('cSelectSection')
        branch:
            EventFlowSystemActor@sub.WaitFrame(60)
            Player.PlayerEndLookDown()
    EventFlowSystemActor.SoundDuckingOff(63)

flow ShowOrder():
    SubNpc.CharacterEmoticonAction('AbsentMindedness', true, '', 0, false)
    EventFlowSystemActor@Character.WaitFrame(4)
    EventFlowSystemActor.CameraSetDemoParam('OrderCut0_1', 'cDefault', '', false, false, true, 0)
    EventFlowSystemActor.WaitFrame(12)
    EventFlowSystemActor.UIHousingOrderListHandling()
    SubNpc.CharacterEmoticonAction('EmotEnd', true, '', 0, false)
    EventFlowSystemActor.CameraSetDemoParam('OrderCut0', 'cDefault', '', false, false, true, 0)
    EventFlowSystemActor.WaitFrame(24)

local flow Sub_Event14():
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:112', true)
    run NewHouseOrderEnd()

local flow Sub_Event57():
    EventFlowSystemActor.WherearenSetNpcOrderFreeTheme()
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:104', false)
    SubNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Spot_WherearenOrder:002', false)
    MainNpc.OpenMessageWindow('TalkSNpc/otg/SP_otg_02_WherearenOrder:105', false)
    run Sub_Event66()

local flow Sub_Event66():
    run SelectField()
    run PostSelectField()

local flow Sub_grp_Event110():
    if Npc_2.CheckNpcLook() in (0, 1, 4, 6):
        Npc_2.CharacterEmoticonAction('Clapping', true, '', 0, false)
    else:
        Npc_2.CharacterEmoticonAction('Smiling', true, '', 0, false)

