flow End():
    if not EventFlowSystemActor.IsMyVillage():
        run ForVisitor()
    elif System.EventFlags['cPlayer:TreasurePlayerWin']:
        run End_Win()
    else:
        run End_Lose()

flow End_Lose():
    if EventFlowSystemActor.HasTargetItem(2545, 1):
        if MainNpc.NpcIsTreasureHuntLimitOver2():
            MainNpc.NpcAddFriendship(1)
        run End_Lose_HasTreasure()
    else:
        if MainNpc.NpcIsTreasureHuntLimitOver2():
            switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:300', true)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:301', true)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:302', true)
        else:
            MainNpc.NpcAddFriendship(-1)
            switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:200', true)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:201', true)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:202', true)
        MainNpc.EventFlags['cNpcMemory:UncollectedFishishTreasureHunt'] = true
        run Treasure_Finish()

flow End_Lose_HasTreasure():
    MainNpc.SetDeliveryItem(0, true)
    if System.EventFlags['cPlayer:TreasureHuntJustMissed'] != 1:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:401', false)
    else:
        System.EventFlags['cPlayer:TreasureHuntJustMissed'] = 0
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:502', false)
    MainNpc.NpcDelivery(0, 'Default')
    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:402', false)
    run Treasure_Finish()

flow End_Win():
    if MainNpc.EventFlags['cNpcTemp:TreasureHuntGiveCancel']:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:012', false)
    else:
        if System.EventFlags['cPlayer:TreasureHuntJustMissed'] != 2:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:001', true)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:002', true)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:003', true)
        else:
            System.EventFlags['cPlayer:TreasureHuntJustMissed'] = 0
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:501', false)
    EventFlowSystemActor.UIItemSelectWindowHandling('cQuest', 65534, '', '', 'cItemSelect', false)
    if MainNpc.IsSelectNpcRequestedItem():
        MainNpc.SetDeliveryItem(4, false)
        MainNpc.NpcDelivery(0, 'Keep')
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:004', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:005', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:006', false)
        run NNPC_Quest_AllReward::Root()
        MainNpc.NpcDelivery(6, '"Default"')
        switch MainNpc.NpcQuestReward():
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:007', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:008', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:009', false)
        MainNpc.SetDeliveryItemApplySave()
        MainNpc.NpcDelivery(10, '"Default"')
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:100', true)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:101', true)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:102', true)
        MainNpc.NpcSetQuestRewardToPlayerBaggage('cSwap')
        MainNpc.AddMemoryEventPlayerForNpc('Present_FromNNPC')
        run Treasure_Finish()
    else:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:010', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_End:011', false)
        MainNpc.EventFlags['cNpcTemp:TreasureHuntGiveCancel'] = true

flow ForVisitor():
    switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
        case 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:100', false)
        case 1:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:101', false)
        case 2:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:102', false)

flow Root():
    if not EventFlowSystemActor.IsMyVillage():
        run ForVisitor()
    elif System.EventFlags['cPlayer:TreasurePlayerWin']:
        run End_Win()
    elif EventFlowSystemActor.NpcQuestIsLimitOver('cTreasure'):
        run End_Lose()
    else:
        run Talk()

flow Talk():
    if EventFlowSystemActor.IsMyVillage():
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:200', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:201', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/Quest/BO_Quest_TreasureHunt_Talk:202', false)
    else:
        run ForVisitor()

flow Treasure_Finish():
    MainNpc.NpcQuestControl('cFinish')
    MainNpc.NpcTreasureToDust()
    System.EventFlags['cLifeSupportDaily:AchieveQuest'] = true
    System.EventFlags['cLifeSupportAchievement:AchieveVillagersQuest'] += 1
    System.EventFlags['cPlayer:HasPlayedTreasureHunt'] = true
    EventFlowSystemActor.SetSharePlayChangeCondition(false)
    EventFlowSystemActor.SetSharePlaySubToolCondition(true)
    MainNpc.EventFlags['cNpcMemory:OrderQuest'] = true
    MainNpc.EventFlags['cNpcTemp:TreasureHuntGiveCancel'] = false

