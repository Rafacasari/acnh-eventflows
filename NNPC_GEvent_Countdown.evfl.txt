flow Chat_After():
    if EventFlowSystemActor.SystemCheckNowStage('cField'):
        if EventFlowSystemActor.EnvHourCompare(2, -1, true, true) == 0:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious4(4, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:060', false)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:061', false)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:062', false)
                case 3:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:063', false)
            EventFlowSystemActor.ExitFlowchart()
        else:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious4(4, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:065', false)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:066', false)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:067', false)
                case 3:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:068', false)
            EventFlowSystemActor.ExitFlowchart()
    elif EventFlowSystemActor.EnvHourCompare(2, -1, true, true) == 0:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious4(4, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:070', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:071', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:072', false)
            case 3:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:073', false)
        EventFlowSystemActor.ExitFlowchart()
    else:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious4(4, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:075', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:076', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:077', false)
            case 3:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:078', false)
        EventFlowSystemActor.ExitFlowchart()

flow Chat_Before():
    if EventFlowSystemActor.EnvHourCompare(23, 59, true, true) != 0:
        if EventFlowSystemActor.SystemCheckNowStage('cField'):
            if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:035', false)
            else:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:036', false)
            EventFlowSystemActor.ExitFlowchart()
        else:
            if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:057', false)
            else:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:058', false)
            EventFlowSystemActor.ExitFlowchart()
    elif not MainNpc.EventFlags['cNpcMemory:GEventTalkProgressFlag']:
        MainNpc.EventFlags['cNpcMemory:GEventTalkProgressFlag'] = true
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:001', false)
        EventFlowSystemActor.ExitFlowchart()
    elif EventFlowSystemActor.SystemCheckNowStage('cField'):
        if EventFlowSystemActor.EnvHourCompare(23, 30, true, true) == 0:
            if (not MainNpc.NpcIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny')) and (not MainNpc.NpcIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny')):
                run WearHat_1hour_Before()
            else:
                switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
                    case 0:
                        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:004', false)
                        EventFlowSystemActor.ExitFlowchart()
                    case 1:
                        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:005', false)
                        EventFlowSystemActor.ExitFlowchart()
                    case 2:
                        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:006', false)
                        EventFlowSystemActor.ExitFlowchart()
                    case 3, 4:
                        run Chat_WithHat_1hour_Before()
        elif EventFlowSystemActor.EnvHourCompare(23, 55, true, true) != 0:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:032', false)
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:033', false)
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:034', false)
            EventFlowSystemActor.ExitFlowchart()
        elif (not MainNpc.NpcIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny')) and (not MainNpc.NpcIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny')):
            run WearHat_30min_Before()
        else:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:018', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:019', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:020', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 3, 4:
                    run Chat_WithHat_30min_Before()
    elif EventFlowSystemActor.EnvHourCompare(23, 30, true, true) == 0:
        if (not MainNpc.NpcIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny')) and (not MainNpc.NpcIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny')):
            run WearHat_1hour_Before()
        else:
            switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
                case 0:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:038', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:039', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 2:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:040', false)
                    EventFlowSystemActor.ExitFlowchart()
                case 3, 4:
                    run Chat_WithHat_1hour_Before()
    elif EventFlowSystemActor.EnvHourCompare(23, 55, true, true) != 0:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:054', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:055', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:056', false)
        EventFlowSystemActor.ExitFlowchart()
    elif (not MainNpc.NpcIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny')) and (not MainNpc.NpcIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny')):
        run WearHat_30min_Before()
    else:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious5(5, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:046', false)
                EventFlowSystemActor.ExitFlowchart()
            case 1:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:047', false)
                EventFlowSystemActor.ExitFlowchart()
            case 2:
                MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:048', false)
                EventFlowSystemActor.ExitFlowchart()
            case 3, 4:
                run Chat_WithHat_30min_Before()

flow Chat_WithHat_1hour_Before():
    if SubflowResults@2[0] == 0:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:007', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:008', false)
    else:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:009', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:010', false)
    EventFlowSystemActor.ExitFlowchart()

flow Chat_WithHat_30min_Before():
    if SubflowResults@2[0] == 0:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:021', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:022', false)
    else:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:023', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:024', false)
    EventFlowSystemActor.ExitFlowchart()

flow Chk_Hat():
    if (not EventFlowSystemActor.PlayerIsEquipItem(4799, 5186, 5187, 5192, 5188, 5190, 5189, 5191, 'cAny', false, true)) and (not EventFlowSystemActor.PlayerIsEquipItem(5946, 5947, 5948, 5953, 5949, 5951, 5950, 5952, 'cAny', false, true)):
        SubflowResults[0] = 1
    else:
        SubflowResults[0] = 0

flow Root():
    if EventFlowSystemActor.EventCheck('Countdown') in (1, 2):
        if EventFlowSystemActor.EnvSameDate('cNewYear', 'cNowTime'):
            run Chat_After()
        else:
            run SetPlayerMemories()
            run Chk_Hat()
            run Chat_Before()

flow SetPlayerMemories():
    if (EventFlowSystemActor.SystemCheckNowStage('cField')) and (MainNpc.IsInEventPlazaArea(false)) and (EventFlowSystemActor.EnvHourCompare(23, 30, false, true) in (1, 2)):
        MainNpc.AddMemoryEventPlayerForNpc('Countdown_TalkNPC')

flow WearHat_1hour_Before():
    if SubflowResults@2[0] == 0:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:011', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:012', false)
        MainNpc.NpcWearNewYearHat()
        MainNpc.EventFlags['cNpcSave:WoreNewYearHat'] = true
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:013', false)
        EventFlowSystemActor.ExitFlowchart()
    else:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:014', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:015', false)
        MainNpc.NpcWearNewYearHat()
        MainNpc.EventFlags['cNpcSave:WoreNewYearHat'] = true
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:016', false)
        EventFlowSystemActor.ExitFlowchart()

flow WearHat_30min_Before():
    if SubflowResults@2[0] == 0:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:025', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:026', false)
        MainNpc.NpcWearNewYearHat()
        MainNpc.EventFlags['cNpcSave:WoreNewYearHat'] = true
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:027', false)
        EventFlowSystemActor.ExitFlowchart()
    else:
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:028', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:029', false)
        MainNpc.NpcWearNewYearHat()
        MainNpc.EventFlags['cNpcSave:WoreNewYearHat'] = true
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/GEvent/BO_GEvent_Countdown:030', false)
        EventFlowSystemActor.ExitFlowchart()

