flow EntryPoint_Cancel():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:801', true)
    EventFlowSystemActor.UIMoneyDisappear()

flow EntryPoint_CancelNega():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:802', true)
    EventFlowSystemActor.UIMoneyDisappear()

flow EntryPoint_ConfirmEndOdekake():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:053', false)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:054', true)
        run EntryPoint_PreProcedure(ContinueAS=true)
        EventFlowSystemActor.WaitFrame(40)
        EventFlowSystemActor.NetEndSessionVillage('cEndVillageSession', false)
        run EntryPoint_PostProcedure()
        EventFlowSystemActor.WaitFrame(30)
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:052', false)
        SubflowResults[1] = 1
        run StartCardEditing()
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:055', false)
        EventFlowSystemActor.UIMoneyDisappear()

flow EntryPoint_ConfirmGateClose():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:050', false)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:051', true)
        run EntryPoint_PreProcedure(ContinueAS=true)
        EventFlowSystemActor.WaitFrame(40)
        EventFlowSystemActor.NetEndSessionVillage('cEndVillageSession', false)
        run EntryPoint_PostProcedure()
        EventFlowSystemActor.CloseVillageGate()
        EventFlowSystemActor.WaitFrame(30)
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:052', false)
        SubflowResults[1] = 1
        run StartCardEditing()
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:804', false)
        EventFlowSystemActor.UIMoneyDisappear()

flow EntryPoint_EditCancel():
    switch EventFlowSystemActor.UIGetMessageCardEditCancelStatus():
        case 0:
            run EntryPoint_EditKeep()
        case 1:
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:522', false)
            if EventFlowSystemActor.HasAttachedPresent():
                DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:550', false)
                EventFlowSystemActor.ReturnAttachedPresentToBaggage()
            EventFlowSystemActor.DeleteUnfinishMail()
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:800', true)
        case 2:
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:523', false)

flow EntryPoint_EditKeep():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:520', false)
    run EntryPoint_EditKeepByNoMoney()

flow EntryPoint_EditKeepByNoMoney():
    if EventFlowSystemActor.HasAttachedPresent():
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:551', false)
        EventFlowSystemActor.ReturnAttachedPresentToBaggage()
    run EntryPoint_SaveToMenu()

flow EntryPoint_PostProcedure():
    DynamicCast_dod.CharacterEmoticonAction('EmotEnd', true, '', 0, false)
    EventFlowSystemActor.WaitFrame(30)
    DynamicCast_dod.TurnBody(12, 0.0)
    EventFlowSystemActor.WaitFrame(30)
    DynamicCast_dod.TurnNeck(10, false)

flow EntryPoint_PreProcedure(ContinueAS: bool):
    DynamicCast_dod.TurnNeck(11, false)
    DynamicCast_dod.TurnBody(12, -90.0)
    DynamicCast_dod.NpcWaitTurn()
    DynamicCast_dod.NpcStartAS('DodProcedure', false, ContinueAS)

flow EntryPoint_SaveToMenu():
    EventFlowSystemActor.MessageLockNext(1)
    DynamicCast_dod.OpenMessageWindow('TalkSys/SYS_Save:001', false)
    EventFlowSystemActor.SaveSimpleSave('cAll')
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.MessageUnlockNext()
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:800', true)

flow EntryPoint_SelectTo():
    EventFlowSystemActor.CreateChoiceMailDestination(false)
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:081', false)
    switch EventFlowSystemActor.GeneralTalkChoice5():
        case 0:
            run Obj_MessageCardRack_01_SendVillage::EntryPoint_SendVillage()
        case 1:
            run Obj_MessageCardRack_02_SendFuture::EntryPoint_SendFuture()
        case 2:
            run Obj_MessageCardRack_03_SendFriend::EntryPoint_SendFriend()
        case 3, 4:
            run EntryPoint_CancelNega()

flow EntryPoint_StartTalk():
    if EventFlowSystemActor.ExistUnfinishMail():
        run Obj_MessageCardRack_05_EditingCardResume::Root()
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:070', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run EntryPoint_SelectTo()
        else:
            run EntryPoint_Cancel()

flow EntryPoint_StockFull():
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:290', false)

flow InDreamSeq():
    DynamicCast_dod.NpcWaitTalkPrepare()
    DynamicCast_dod.TurnBody(10, 0.0)
    Player.TurnBody(0, 0.0)
    if not System.EventFlags['cPlayerTemp:DodDreamTalk']:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:1001', false)
        System.EventFlags['cPlayerTemp:DodDreamTalk'] = true
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:1002', false)

flow MesCardEnable_MovingFirstDay():
    if EventFlowSystemActor.NetIsDreaming():
        run InDreamSeq()
    elif not EventFlowSystemActor.IsMyVillage():
        Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:090', false)
    elif not System.EventFlags['cPlayer:OdekakeFirstTalk']:
        DynamicCast_dod.NpcWaitTalkPrepare()
        DynamicCast_dod.TurnBody(10, 0.0)
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_AirPort:998', false)
    elif EventFlowSystemActor.NetHasVisitor():
        Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:091', false)
    elif EventFlowSystemActor.PlayerHouseLevel() == `Homeless`:
        Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:010', false)
        DynamicCast_dod.NpcWaitTalkPrepare()
        DynamicCast_dod.TurnBody(10, 0.0)
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_AirPort:999_02', false)
    else:
        EventFlowSystemActor.UIMoneyAppear()
        Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:010', false)
        if EventFlowSystemActor.HasBellCount(200):
            DynamicCast_dod.NpcWaitTalkPrepare()
            DynamicCast_dod.TurnBody(10, 0.0)
            if not EventFlowSystemActor.NetIsConnected():
                run Obj_MessageCardRack_03_SendFriend::EntryPoint_CheckUnlockFriend()
            elif EventFlowSystemActor.IsVillageGateOpened():
                run EntryPoint_ConfirmGateClose()
            else:
                run EntryPoint_ConfirmEndOdekake()
        else:
            Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:011', false)
            EventFlowSystemActor.UIMoneyDisappear()

flow Root():
    if System.EventFlags['cLand:VillageDaysCount'] >= 1:
        run MesCardEnable_MovingFirstDay()
    elif System.EventFlags['cLand:IslandProducedByPlayerMoving']:
        run MesCardEnable_MovingFirstDay()
    else:
        Player.OpenMessageWindow('TalkObj/OBJ_MessageCardRack:001', false)

flow StartCardEditing():
    run EntryPoint_StartTalk()

