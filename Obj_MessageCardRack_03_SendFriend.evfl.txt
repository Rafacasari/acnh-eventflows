flow EntryPoint_CheckUnlockFriend():
    if System.EventFlags['cPlayer:FriendMailSendEnable']:
        run Obj_MessageCardRack::EntryPoint_StartTalk()
    elif (System.EventFlags['cPlayer:NetIsRegistHomeLand']) and (EventFlowSystemActor.NetHasAddressData('cFriend')):
        System.EventFlags['cPlayer:FriendMailSendEnable'] = true
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:010', false)
        if not System.EventFlags['cPlayer:FriendMailGuideRetentionPeriod']:
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:020', true)
            EventFlowSystemActor.OpenMessageWindow('Dialog/DIALOG_Msg:0335', false)
            System.EventFlags['cPlayer:FriendMailGuideRetentionPeriod'] = true
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:040', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run Obj_MessageCardRack::EntryPoint_SelectTo()
        else:
            run Obj_MessageCardRack::EntryPoint_Cancel()
    else:
        run Obj_MessageCardRack::EntryPoint_StartTalk()

flow EntryPoint_EditFriend():
    EventFlowSystemActor.CheckFreeCommunication(true)
    if EventFlowSystemActor.IsApprovedFreeCommunication():
        run Sub_Event46()
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:311', true)

flow EntryPoint_RetrySendFriend():
    run Obj_MessageCardRack::EntryPoint_PreProcedure(ContinueAS=true)
    EventFlowSystemActor.MessageLockNext(1)
    DynamicCast_dod.OpenMessageWindow('TalkSys/SYS_Network:001', false)
    EventFlowSystemActor.NetConnectInit('cConnectInet', true)
    if EventFlowSystemActor.CheckErrorType(2):
        run EntryPoint_SendError()
    else:
        EventFlowSystemActor.NetCheckNSA('cCheckNSA', true)
        if EventFlowSystemActor.CheckErrorType(2):
            run EntryPoint_SendError()
        else:
            if not System.EventFlags['cPlayer:NetIsRegistHomeLand']:
                run Popid_Check()
            EventFlowSystemActor.MessageSuspend()
            DynamicCast_dod.OpenMessageWindow('TalkSys/SYS_Network:010', false)
            EventFlowSystemActor.SuspendSharePlayCtrlCheck()
            EventFlowSystemActor.UISaveIconAppear()
            EventFlowSystemActor.NetSendMailPreProc('cMessageCard')
            EventFlowSystemActor.SaveSimpleSave('cAll')
            EventFlowSystemActor.UISaveIconDisappear()
            EventFlowSystemActor.NetSendMail()
            if EventFlowSystemActor.CheckErrorType(2):
                EventFlowSystemActor.NetSendMailAfterFailProc()
                EventFlowSystemActor.ResumeSharePlayCtrlCheck()
                run EntryPoint_SendError()
            else:
                System.EventFlags['cPlayer:MessageCardPayment'] = false
                EventFlowSystemActor.ResumeSharePlayCtrlCheck()
                EventFlowSystemActor.MessageSuspend()
                EventFlowSystemActor.MessageUnlockNext()
                run Obj_MessageCardRack::EntryPoint_PostProcedure()
                DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:501', true)
                EventFlowSystemActor.UIMoneyDisappear()

flow EntryPoint_SendError():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.MessageUnlockNext()
    run Obj_MessageCardRack::EntryPoint_PostProcedure()
    EventFlowSystemActor.UIMoneyAppear()
    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:380', true)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        run EntryPoint_RetrySendFriend()
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:381', false)
        EventFlowSystemActor.BellCountDown(200, false)
        if EventFlowSystemActor.HasAttachedPresent():
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:382', true)
            EventFlowSystemActor.ReturnAttachedPresentToBaggage()
        EventFlowSystemActor.MessageSuspend()
        System.EventFlags['cPlayer:MessageCardPayment'] = false
        EventFlowSystemActor.UIMoneyDisappear()
        run Obj_MessageCardRack::EntryPoint_SaveToMenu()

flow EntryPoint_SendFriend():
    EventFlowSystemActor.UIMoneyDisappear()
    EventFlowSystemActor.CheckFreeCommunication(true)
    if not EventFlowSystemActor.IsApprovedFreeCommunication():
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:311', true)
    elif EventFlowSystemActor.NetHasPOPID(false):
        EventFlowSystemActor.NetUpdateFriendList('cFriendOnly')
        if EventFlowSystemActor.NetHasAddressData('cFriend'):
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:301', true)
            EventFlowSystemActor.UIMoneyDisappear()
            EventFlowSystemActor.UIAddresseeFriendHandling()
            if EventFlowSystemActor.UIResultMenuDecide():
                EventFlowSystemActor.SetTagFromUIResult('cSelectFriendName', 0)
                if EventFlowSystemActor.LimitSendMailToFriend():
                    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:320', true)
                else:
                    DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:210_01', true)
                    if EventFlowSystemActor.ExistUnfinishMail():
                        EventFlowSystemActor.ChangeAddressUnfinishMail()
                        run Sub_Event46()
                    else:
                        EventFlowSystemActor.UIMoneyDisappear()
                        EventFlowSystemActor.UIMsgCardSelectHandling()
                        if EventFlowSystemActor.UIResultMenuDecide():
                            run Sub_Event46()
                        else:
                            run Obj_MessageCardRack::EntryPoint_Cancel()
            else:
                run Obj_MessageCardRack::EntryPoint_Cancel()
        else:
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:312', true)
    else:
        DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:312', true)

flow Popid_Check():
    EventFlowSystemActor.NetGetPOPID(true)
    if EventFlowSystemActor.CheckErrorType(2):
        run EntryPoint_SendError()
    else:
        run System_ServerRegistration::UploadProfileCore(IgnoreError=false, Terminate=false)
        if EventFlowSystemActor.CheckErrorType(2):
            run EntryPoint_SendError()

local flow Sub_Event46():
    EventFlowSystemActor.UIMoneyDisappear()
    EventFlowSystemActor.UIMsgCardEditTextHandling('cMessageCard')
    if EventFlowSystemActor.UIResultMenuDecide():
        EventFlowSystemActor.SaveSetFromUIResult('cMsgCard')
        EventFlowSystemActor.UIMoneyAppear()
        if EventFlowSystemActor.HasBellCount(200):
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:500', true)
            System.EventFlags['cPlayer:MessageCardPayment'] = true
            EventFlowSystemActor.BellCountDown(-200, false)
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:321', true)
            EventFlowSystemActor.UIMoneyDisappear()
            run EntryPoint_RetrySendFriend()
        else:
            DynamicCast_dod.OpenMessageWindow('TalkSNpc/dod/SP_dod_50_PostOffice:510', true)
            EventFlowSystemActor.UIMoneyDisappear()
            run Obj_MessageCardRack::EntryPoint_EditKeepByNoMoney()
    else:
        run Obj_MessageCardRack::EntryPoint_EditCancel()

