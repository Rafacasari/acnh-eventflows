flow Root():
    EventFlowSystemActor.CameraSetDemoParam('PreTkkLive', 'PreTkkLive', 'Npc:tkk', false, false, false, 0)
    SubflowResults[1] = 0
    MainNpc.TkkRequestSongSet('cTkkSelectSongMethod_ToContext', 'cTkkSelectFeelType_None')
    EventFlowSystemActor.SetTagFromSystem('cTkkLiveRequest', 'cDegit', 0, 0, '')
    run Tkk_Live_JudgeMiss()
    run Tkk_LiveBefore_Msg()
    run Tkk_LiveDemo()
    run Tkk_Live_Clap()
    if SubflowResults@2[0] == 0:
        MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:003', false)
    MainNpc.TkkFreeAction('cTkkActionType_ToIdle')
    run Tkk_LiveAfter_Flag()
    run Tkk_Live_Stop_Clap()
    run Tkk_LiveAfter_JudgeGet()
    run Tkk_LiveAfter_LastWord()
    run Tkk_Live_FlowEnd()

flow Root_Init():
    MainNpc.NpcAISetting(3, false)
    MainNpc.NpcAISetting(4, false)

local flow Sub_Event58():
    EventFlowSystemActor.SoundDuckingOn(17)
    EventFlowSystemActor.FadeOut('cNormalFader', 'cNormalFader', 'cBlack', 0.10000000149011612, 0.10000000149011612, false)
    EventFlowSystemActor.SoundDuckingOff(39)
    EventFlowSystemActor.SoundDuckingOff(40)
    MainNpc.TkkLiveEnter()
    EventFlowSystemActor.BGMPropertyControl(77)
    EventFlowSystemActor.FadeIn(true)
    Player.PlayerTotakekeLiveGetRhythm()
    EventFlowSystemActor.TotakekeLiveNpcRhythm()

flow Tkk_1stLIveMC():
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:001', false)
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:002', false)
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:003', false)
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:004', true)
    EventFlowSystemActor.WaitFrame(10)
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:005', true)

flow Tkk_BdayLive_EndMC():
    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:023', false)

flow Tkk_LandFirstLive():
    run SNPC_tkk::Tkk_JudgeNew()
    EventFlowSystemActor.CameraSetDemoParam('PreTkkLive', 'PreTkkLive', 'Npc:tkk', false, false, false, 0)
    SubflowResults[1] = 1
    MainNpc.TkkRequestSongSet('cTkkSelectSongMethod_Feeling', 'cTkkSelectFeelType_First')
    run Tkk_1stLIveMC()
    run Tkk_LiveDemo()
    MainNpc.TkkFreeAction('cTkkActionType_ToIdle')
    run Tkk_LiveAfter_Flag()
    fork:
        branch:
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_1stLive:011', true)
            EventFlowSystemActor.WaitFrame(90)
            EventFlowSystemActor.SoundDuckingOn(35)
            EventFlowSystemActor.FadeOut('cNormalFader', 'cNormalFader', 'cBlack', 0.10000000149011612, 0.10000000149011612, false)
        branch:
            EventFlowSystemActor@WaitForCrapHand.WaitFrame(100)
            Player.CharacterEmoticonAction('Clapping', false, '', 0, true)
            EventFlowSystemActor@WaitForCrapHand.TkkFirstLiveEmoticcon('Clapping', 120)
            EventFlowSystemActor@WaitForCrapHand.WaitFrame(20)
            Player.CharacterEmoticonAction('EmotEnd', true, '', 0, false)
    EventFlowSystemActor.SystemRequestChangeStage('cMainFieldPlayerHouse', 'cCircle', 'cCircle', 'cBlack', 1.0, 1.0)

flow Tkk_LiveAfter_Flag():
    if SubflowResults@2[1] != 0:
        System.EventFlags['cPlayer:TkkFirstLiveJoined'] = true
        System.EventFlags['cPlayer:TkkTalkToday'] = true
        System.EventFlags['cPlayer:TkkLiveToday'] = true
        EventFlowSystemActor.ReserveTownNews()
        System.EventFlags['cPlayer:TotakekeLiveCount'] += 1
        System.EventFlags['cLifeSupportAchievement:GotoTotakekeShow'] += 1
        System.EventFlags['cPlayer:StandByRcoVisitMyHomeAfterTkkFirstLive'] = true
    elif not EventFlowSystemActor.IsMyVillage():
        System.EventFlags['cPlayerVisit:TkkVisitorLive'] = true
    elif not System.EventFlags['cPlayer:TkkLiveToday']:
        System.EventFlags['cPlayer:TkkLiveToday'] = true
        System.EventFlags['cPlayer:TotakekeLiveCount'] += 1
        System.EventFlags['cLifeSupportAchievement:GotoTotakekeShow'] += 1

flow Tkk_LiveAfter_JudgeGet():
    if (not System.EventFlags['cPlayer:TkkGetMusicToday']) and (EventFlowSystemActor.IsMyVillage()) and (SubflowResults@2[0] == 1):
        MainNpc.DecideEventReward('cTotakeke')
        if EventFlowSystemActor.IsSharePlay(0):
            if not System.EventFlags['cLandTemp:Tkk_MusicFlag']:
                run Tkk_LiveAfter_MusicGet_Multi()
                System.EventFlags['cPlayer:TkkGetMusicToday'] = true
        else:
            if MainNpc.TkkFreeQuery2('cTkkQueryType_AudienceMulti'):
                run Tkk_LiveAfter_MusicGet_Multi()
                System.EventFlags['cPlayer:TkkGetMusicToday'] = true
            else:
                run Tkk_LiveAfter_MusicGet_Single()
                System.EventFlags['cPlayer:TkkGetMusicToday'] = true

flow Tkk_LiveAfter_LastWord():
    switch MainNpc.TkkLiveType():
        case 0:
            if not MainNpc.TkkFreeQuery2('cTkkQueryType_AudienceMulti'):
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:016', false)
            elif not EventFlowSystemActor.IsSharePlay(0):
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:015', false)
        case 1:
            if EventFlowSystemActor.DisplayedNewBirthDayMessage():
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:024', false)
                EventFlowSystemActor.SendBirthDayMessage()
                run Tkk_BdayLive_EndMC()
            else:
                run Tkk_BdayLive_EndMC()
        case 2:
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:029', false)

flow Tkk_LiveAfter_MusicGet_Multi():
    switch MainNpc.TkkLiveType():
        case 0:
            if EventFlowSystemActor.IsSharePlay(0):
                EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 4, 'cNone', 'cFastTomorrow', 'cReward', true, false)
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:019', false)
                System.EventFlags['cLandTemp:Tkk_MusicFlag'] = true
            else:
                EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 2, 'cNone', 'cFastTomorrow', 'cReward', false, false)
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:027', false)
        case 1:
            EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 3, 'cNone', 'cFastTomorrow', 'cReward', false, true)
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:020', false)
        case 2:
            EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 2, 'cNone', 'cFastTomorrow', 'cReward', false, false)
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:025', false)

flow Tkk_LiveAfter_MusicGet_Single():
    MainNpc.SetDeliveryItem(1, false)
    if EventFlowSystemActor.ShoppingCapacity('cReward', 65534):
        switch MainNpc.TkkLiveType():
            case 0:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:017', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:021', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:026', false)
        MainNpc.SetEventRewardToPlayerBaggage('cFree')
    else:
        switch MainNpc.TkkLiveType():
            case 0:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:018', false)
                run Tkk_Live_FlowEnd()
            case 1:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:022', false)
                EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 3, 'cNone', 'cFastTomorrow', 'cReward', true, true)
            case 2:
                MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:025', false)
                EventFlowSystemActor.SystemMailSend('cTkk', 'MAIL_SNpc_tkk', 2, 'cNone', 'cFastTomorrow', 'cReward', false, false)

flow Tkk_LiveBefore_Msg():
    EventFlowSystemActor.SetTkkLiveRequestPlayerName()
    switch MainNpc.TkkLiveType():
        case 0:
            run Tkk_Live_JudgeNew()
            switch MainNpc.TkkQeruestMethodType():
                case 0:
                    if SubflowResults@2[0] == 0:
                        MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:002', false)
                    else:
                        MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:001', false)
                case 1:
                    switch MainNpc.TkkRequestFeeling():
                        case 0:
                            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:004', false)
                        case 1:
                            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:005', false)
                        case 2:
                            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:006', false)
                        case 3:
                            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:007', false)
                        case 4:
                            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:008', false)
                case 2:
                    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:001', false)
        case 1:
            switch MainNpc.CompareDayBirthdayLive():
                case 0:
                    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:012', false)
                case 1:
                    pass
                case 2:
                    MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:013', false)
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:009', false)
        case 2:
            MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:011', false)

flow Tkk_LiveDemo():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.SoundDuckingOn(39)
    EventFlowSystemActor.SoundDuckingOn(40)
    EventFlowSystemActor.WaitFrame(90)
    run Tkk_LiveDemoEnter()
    MainNpc.TkkLive()
    run Tkk_LiveDemoExit()

flow Tkk_LiveDemoEnter():
    if SubflowResults@2[1] == 0:
        MainNpc.TkkLiveSyncPlayerAction()
        fork:
            branch:
                Player.PlayerChairStandup(0)
                if not EventFlowSystemActor.PlayerIsEquipItem(14504, 5741, 65534, 65534, 65534, 65534, 65534, 65534, 'cAny', false, false):
                    Player.PlayerToolPutaway()
                EventFlowSystemActor.SubPlayerToolPutawayForLive()
                EventFlowSystemActor.WaitFrame(20)
                Player.PlayerTotakekeTurnToStarter()
            branch:
                EventFlowSystemActor@Sub.TkkLiveNpcStandUp()
        EventFlowSystemActor.WaitFrame(15)
        run Sub_Event58()
    else:
        Player.PlayerToolPutaway()
        run Sub_Event58()

flow Tkk_LiveDemoExit():
    EventFlowSystemActor.FadeOut('cNormalFader', 'cNormalFader', 'cBlack', 0.10000000149011612, 0.10000000149011612, true)
    MainNpc.TkkLiveExit()
    EventFlowSystemActor.SoundDuckingOff(17)
    if MainNpc.TkkLiveType() in (0, 1):
        EventFlowSystemActor.BGMPropertyControl(88)
    EventFlowSystemActor.FadeIn(true)

flow Tkk_Live_Clap():
    fork:
        branch:
            Player.TkkLivePlayerClapping(false)
        branch:
            EventFlowSystemActor.TkkLiveNpcClapping()
    EventFlowSystemActor.WaitFrame(90)

flow Tkk_Live_FlowEnd():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.TkkLiveNpcSetStickLight(true)
    EventFlowSystemActor.TkkLiveNpcSitDown()
    EventFlowSystemActor.ExitFlowchart()

flow Tkk_Live_JudgeMiss():
    if (MainNpc.TkkLiveType() == 0) and (MainNpc.TkkQeruestMethodType() == 0) and (EventFlowSystemActor.MultiFromItemSelectInclude('TkkMiss', '', '', '', '', '', '', '', 'cPresetItem')):
        SubflowResults[0] = 0
    else:
        SubflowResults[0] = 1

flow Tkk_Live_JudgeNew():
    if (EventFlowSystemActor.MultiFromItemSelectInclude('TkkNewRelax', 'TkkNewUnsure', 'TkkNewGood', 'TkkNewBad', 'TkkNewBlue', '', '', '', 'cPresetItem')) and (MainNpc.TkkFreeQuery2('cTkkQueryType_PlayFirstNewSong')):
        MainNpc.OpenMessageWindow('TalkSNpc/tkk/SP_tkk_Live:014', false)

flow Tkk_Live_Stop_Clap():
    fork:
        branch:
            Player.TkkLivePlayerClapping(true)
        branch:
            EventFlowSystemActor.TkkLiveNpcStopClapping()

