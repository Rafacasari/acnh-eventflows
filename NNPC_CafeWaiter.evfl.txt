flow CafeBuy_Again():
    EventFlowSystemActor.UICafeMenuReselectionAppearHandling()
    run Event8()

flow CafeBuy_Chk():
    if not MainNpc.ShopHasBellCount(1.0):
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:026', false)
        run Sub_Event10()
    elif EventFlowSystemActor.SystemHasBaggageSpace('cPocketBag') < 1:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:027', false)
        run Sub_Event10()
    else:
        MainNpc.SetDeliveryItem(53, false)
        MainNpc.ShopBuyDone(false, false, false, false)
        MainNpc.NpcDelivery(8, 'Default')
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:023', true)

flow CafeUI_Close():
    fork:
        branch:
            EventFlowSystemActor.MessageSuspend()
        branch:
            EventFlowSystemActor@sub1.UIPokiDisappear()
        branch:
            EventFlowSystemActor@sub2.UICafeMenuDisappearHandling()

flow Cancel():
    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:022', true)

flow CarryTray():
    run Root()

flow EnterFacility():
    MainNpc.TurnBody(10, 0.0)
    if EventFlowSystemActor.WherearenExistFacilityName('cCafe'):
        EventFlowSystemActor.WherearenSetTagRunningOrderTheme('cSelectFacility', 0, 'cCafe')
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:091', false)
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:092', false)
    if EventFlowSystemActor.IsInspectingWherearen():
        EventFlowSystemActor.StartMeasurePlayTime('cWherearenInspect')

flow ExitFacility():
    MainNpc.TurnBody(10, 0.0)
    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:093', false)

flow FacilityName_Chk():
    if (EventFlowSystemActor.WherearenExistFacilityName('cCafe')) and (not EventFlowSystemActor.PercentChoice(80)):
        EventFlowSystemActor.WherearenSetTagRunningOrderTheme('cSelectFacility', 0, 'cCafe')
        if MainNpc.IsNthRole(0):
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:002', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:012', false)
        run KKFes_Chk()
        EventFlowSystemActor.ExitFlowchart()

flow KKFes_Chk():
    if MainNpc.NpcIsSitting() in (0, 1, 2, 3, 5):
        EventFlowSystemActor.ExitFlowchart()
    elif not EventFlowSystemActor.IsInspectingWherearen():
        MainNpc.TurnBody(10, 0.0)
        MainNpc.TurnNeck(10, false)
        if EventFlowSystemActor.WherearenKKFesStatus(false) in (0, 1, 3):
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:021', false)
            if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                run LookMenu()
            else:
                run Cancel()
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:031', false)
            switch EventFlowSystemActor.GeneralTalkChoice3():
                case 0:
                    run LookMenu()
                case 1:
                    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_KKFes:109', true)
                    run Demo_Common_Wherearen::ToKKFesDemoLive()
                case 2:
                    run Cancel()

flow LookMenu():
    EventFlowSystemActor.UIPokiAppear()
    MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:030', false)
    EventFlowSystemActor.UICafeMenuAppearHandling()
entrypoint Event8:
    if EventFlowSystemActor.UIResultMenuDecide():
        EventFlowSystemActor.SetTagFromUIResult('cWherearenCafeMenuPrice', 0)
        EventFlowSystemActor.SetTagFromUIResult('cWherearenCafeMenuName', 0)
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:025', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run CafeBuy_Chk()
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:028', false)
        else:
            MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:029', false)
        run CafeBuy_Again()
    else:
        run CafeUI_Close()
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:024', true)

flow Root():
    if not EventFlowSystemActor.IsInspectingWherearen():
        run ShareHouseMate_Chk()
    MainNpc.WherearenSetTagFacilityNpcName('cCafeWaiter', false, false, 0)
    run FacilityName_Chk()
    if MainNpc.IsNthRole(0):
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:001', false)
        run KKFes_Chk()
    else:
        MainNpc.OpenMessageWindow('TalkNNpc/B1_Bo/OneRoom/BO_Facility_Cafe:011', false)
        run KKFes_Chk()

flow ShareHouseMate_Chk():
    if EventFlowSystemActor.WherearenOrderStatus() == 1:
        MainNpc.TurnNeck(10, false)
        run NNPC_Spot_WherearenMainFieldVisitor::LookforHouseMate()
        EventFlowSystemActor.ExitFlowchart()

flow StandSleep():
    run NNPC_RestaurantCustomer::`StandSleep_2.1`()

local flow Sub_Event10():
    run CafeUI_Close()
    EventFlowSystemActor.ExitFlowchart()

