flow AfterJuneBrideFirstEv():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1003', false)
    EventFlowSystemActor.ExitFlowchart()

flow ChkUnlockDirectRoute():
    if not System.EventFlags['cPlayer:DocUnlockSpnOtgDirectRoute']:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1106', false)
        System.EventFlags['cPlayer:DocUnlockSpnOtgDirectRoute'] = true
        if System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1107', false)
            run ReturnDirectRoute()
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1108', false)
            run ReturnDirectRoute_Sel3()
        EventFlowSystemActor.ExitFlowchart()

flow Chk_CommuneExpandEvent_Arrive():
    if System.EventFlags['cPlayer:ReserveCommuneExpansion']:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1001', true)
        MainNpc.TurnNeck(11, false)
        MainNpc.TurnBody(12, 190.0)
        MainNpc.NpcWaitTurn()
        MainNpc.CharacterEmoticonAction('Eh', true, '', 0, false)
        EventFlowSystemActor.WaitFrame(30)
        MainNpc.TurnBody(10, 0.0)
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1002', true)
        EventFlowSystemActor.ExitFlowchart()

flow Chk_CommuneExpandEvent_Wait():
    if System.EventFlags['cPlayer:ReserveCommuneExpansion']:
        if not System.EventFlags['cPlayer:SpnExpandEventAfterJuneBride']:
            run AfterJuneBrideFirstEv()
        elif System.EventFlags['cPlayerTemp:DocSpnExpandEventAfterJuneBride']:
            run AfterJuneBrideFirstEv()
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1004', false)
            System.EventFlags['cPlayerTemp:DocSpnExpandEventAfterJuneBride'] = true
            EventFlowSystemActor.ExitFlowchart()

flow Doc_Cancel():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:113', false)
    EventFlowSystemActor.ExitFlowchart()

flow Doc_CancelGo():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:104', true)

flow Doc_CommuneExpansionWalk():
    Player.PlayerMoveToTarget(false, 715.0, 635.0, 0.0, 0.0, true, 'cDemoTalk')
    EventFlowSystemActor.WaitFrame(15)
    EventFlowSystemActor.SetNpcAIBlackBoardByLabel('spn', 'CommuneDemoSpeak', 1, 1)

flow Doc_Delivery():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:111', false)
    EventFlowSystemActor.UIItemSelectWindowHandling('cMoveToChest', 65534, '', '', 'cItemSelect', false)
    if not EventFlowSystemActor.UIResultMenuDecide():
        run Doc_Cancel()
    elif EventFlowSystemActor.UISelectedItemCanMoveChest():
        EventFlowSystemActor.UISelectedItemMoveChest()
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:116', false)
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:118', false)
        run Doc_Thanks()
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:112', false)

flow Doc_DeliveryPurchaseExplain():
    if not System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
        if (EventFlowSystemActor.TermEventNow('JuneBride', false)) and (System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']):
            run Sub_Event50()
        else:
            run SNPC_spn_02_Commune::ChkEnableDonation()
            if SubflowResults@3[2] in (1, 2):
                run Sub_Event50()

flow Doc_FirstJuneBride():
    EventFlowSystemActor.StoreNormalCamera(false, '')
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:001', true)
    MainNpc.TurnBody(12, 190.0)
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:002', true)
    EventFlowSystemActor.StoreNormalCamera(false, '')
    EventFlowSystemActor.WaitFrame(15)

flow Doc_FirstJuneBrideWalk():
    if System.EventFlags['cLand:CommuneExpanded']:
        Player.PlayerMoveToTarget(false, 685.0, 847.0, 0.0, 0.0, true, 'cDemoTalk')
    else:
        Player.PlayerMoveToTarget(false, 365.0, 527.0, 0.0, 0.0, true, 'cDemoTalk')
    EventFlowSystemActor.SetNpcAIBlackBoardByLabel('spn', 'DemoSpeak', 1, 1)

flow Doc_GoAOC():
    if not EventFlowSystemActor.IsWherearenAocAvailable():
        run SNPC_dod_40_Airport_Wherearen::NoAoC()
    elif EventFlowSystemActor.EnvHourOverGrowUp():
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1105', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1102', false)
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1103', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1104', true)
            System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = false
            run SNPC_dod_40_Airport_Wherearen::Dod_GoToWherearen()
        else:
            run Doc_CancelGo()

flow Doc_GoMainIsland():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:102', false)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:103', true)
        System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = false
        EventFlowSystemActor.BGMPropertyControl(76)
        EventFlowSystemActor.SoundTriggerEmit('Airplane_Takeoff_Short', -1)
        System.EventFlags['cLandTemp:DocReturnFromIsland'] = true
        EventFlowSystemActor.SystemRequestChangeStage('cFromOutlierToHomeland', 'cDALWithLoadWait', 'cCircle', 'cBlack', 1.0, 1.0)
    else:
        run Doc_CancelGo()

flow Doc_NoService():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:101', false)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        run Doc_GoMainIsland()
    else:
        run Doc_CancelGo()

flow Doc_Purchase(SellTotal: int = 0):
    if EventFlowSystemActor.PurchaseBoxFreeQuery2('cPurchaseBoxQueryType_SavingFull', 0):
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:121', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:124', false)
            EventFlowSystemActor.UIItemSelectWindowHandling('cSellBox', 65534, '', '', 'cItemSelect', false)
            if EventFlowSystemActor.UIResultMenuDecide():
                EventFlowSystemActor.SystemDeletePlayerItem('cItemWindow', 1)
                MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:126', false)
                run Doc_Thanks()
            else:
                run Doc_Cancel()
        else:
            run Doc_Cancel()
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:120', false)
        EventFlowSystemActor.UIItemSelectWindowHandling('cSellBox', 65534, '', '', 'cPurchaseBox', false)
        if EventFlowSystemActor.UIResultMenuDecide():
            EventFlowSystemActor.ShopSellCalc(SellTotal, 1.0, false, true)
            EventFlowSystemActor.ShopSellDone(1.0, true)
            System.EventFlags['cLifeSupportAchievement:SellItemRcm'] += 1
            System.EventFlags['cPlayer:DocUsePurchaseServiceFalg'] = true
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:125', false)
            run Doc_Thanks()
        else:
            run Doc_Cancel()

flow Doc_Service():
    run Chk_CommuneExpandEvent_Wait()
    run Doc_DeliveryPurchaseExplain()
    if (System.EventFlags['cPlayer:CommuneCompleteExpandEvent_Player']) and (System.EventFlags['cPlayer:WHEREAREN_VisitDone']):
        run ChkUnlockDirectRoute()
        if System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1101', false)
            run ReturnDirectRoute()
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:1100', false)
            run ReturnDirectRoute_Sel3()
    elif System.EventFlags['cPlayer:DocDeliveryPurchaseExplain']:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:110', false)
        switch EventFlowSystemActor.GeneralTalkChoice4():
            case 0:
                run Doc_GoMainIsland()
            case 1:
                run Doc_Delivery()
            case 2:
                run Doc_Purchase()
            case 3:
                run Doc_CancelGo()
    else:
        run Doc_NoService()

flow Doc_Thanks():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:127', false)
    EventFlowSystemActor.ExitFlowchart()

flow ReturnDirectRoute():
    switch EventFlowSystemActor.GeneralTalkChoice5():
        case 0:
            run Doc_GoMainIsland()
        case 1:
            run Doc_GoAOC()
        case 2:
            run Doc_Delivery()
        case 3:
            run Doc_Purchase()
        case 4:
            run Doc_CancelGo()

flow ReturnDirectRoute_Sel3():
    switch EventFlowSystemActor.GeneralTalkChoice3():
        case 0:
            run Doc_GoMainIsland()
        case 1:
            run Doc_GoAOC()
        case 2:
            run Doc_CancelGo()

flow Root():
    if not System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone']:
        System.EventFlags['cPlayerTemp:DocCommuneIslandFirstTalkDone'] = true
        if (EventFlowSystemActor.TermEventNow('JuneBride', false)) and (System.EventFlags['cPlayer:CommuneIslandAvailable']) and (not System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']):
            run Doc_FirstJuneBride()
        elif System.EventFlags['cLand:MolConv']:
            EventFlowSystemActor.ExitFlowchart()
        else:
            run Chk_CommuneExpandEvent_Arrive()
            MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:001', true)
    elif not EventFlowSystemActor.TermEventNow('JuneBride', false):
        run Doc_Service()
    elif not System.EventFlags['cPlayer:CommuneIslandAvailable']:
        run Doc_Service()
    elif System.EventFlags['cPlayer:SpnJuneBrideTalkEventFrag']:
        run Doc_Service()
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:200', false)

local flow Sub_Event50():
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:105', false)
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:106', false)
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:107', false)
    MainNpc.OpenMessageWindow('TalkSNpc/doc/SP_doc_52_CommuneIsland:108', false)
    System.EventFlags['cPlayer:DocDeliveryPurchaseExplain'] = true
    System.EventFlags['cPlayer:PlayerPocketUIEnableInCommuneIsland'] = true
    EventFlowSystemActor.ExitFlowchart()

