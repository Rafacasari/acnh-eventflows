flow Bpt_Finish_FortuneTelling():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.WaitFrame(15)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTellingEnd_ShineWeakly')
    EventFlowSystemActor.SystemBGMVolumeChange(-9.0, 1.0, 0, 0.0)
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTellingEnd_GoOut')
    EventFlowSystemActor.WaitFrame(65)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cCandle_Off')
    EventFlowSystemActor.SystemBGMVolumeFadeOut(0.75, 0, 0.0)
    fork:
        branch:
            EventFlowSystemActor.WaitFrame(35)
            if SubflowResults@4[3] in (2, 3):
                MainNpc.CharacterEmoticonAction('EmotEnd', false, '', 0, false)
        branch:
            EventFlowSystemActor@Sub.WaitFrame(35)
    EventFlowSystemActor.SoundDuckingOff(53)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cEnvEffect_Out')
    EventFlowSystemActor.WaitFrame(50)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cWaiting')
    if SubflowResults@4[3] not in (0, 1):
        EventFlowSystemActor.WaitFrame(15)
        Player.PlayerChangeStateDemoTalk()
        EventFlowSystemActor.WaitFrame(20)
    EventFlowSystemActor.BGMPropertyControl(133)
    EventFlowSystemActor.SystemBGMVolumeReset(0.0, 0, 0.0)

flow Bpt_PayExtraFee():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.WaitFrame(5)
    EventFlowSystemActor.BellCountDown(10000, true)
    EventFlowSystemActor.WaitFrame(10)
    EventFlowSystemActor.UIMoneyDisappear()
    EventFlowSystemActor.BGMPropertyControl(156)

flow Bpt_PayFortuneFee():
    EventFlowSystemActor.MessageSuspend()
    EventFlowSystemActor.WaitFrame(5)
    EventFlowSystemActor.BellCountDown(1000, true)
    EventFlowSystemActor.WaitFrame(10)
    EventFlowSystemActor.UIMoneyDisappear()
    EventFlowSystemActor.BGMPropertyControl(155)

flow Bpt_Start_FortuneTelling():
    if SubflowResults@4[3] in (0, 1):
        MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:021_01', true)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:021_02', true)
    Player.PlayerFortuneCloseEyes()
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cEnvEffect_In')
    EventFlowSystemActor.SystemBGMVolumeFadeOut(5.0, 3, 0.0)
    EventFlowSystemActor.SoundDuckingOn(53)
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.SoundTriggerEmit('WindChime', -1)
    EventFlowSystemActor.WaitFrame(150)
    EventFlowSystemActor.BGMPropertyControl(131)
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cCandle_On')
    EventFlowSystemActor.SystemBGMVolumeReset(0.0, 0, 0.0)
    EventFlowSystemActor.BGMPropertyControl(132)
    EventFlowSystemActor.WaitFrame(60)
    MainNpc.NpcStartAS('BptASpell', false, true)
    EventFlowSystemActor.WaitFrame(7)
    fork:
        branch:
            switch SubflowResults@4[3]:
                case 0, 1:
                    MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:022_01', false)
                case 2:
                    MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:022_02', false)
                case 3:
                    MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:022_03', false)
        branch:
            EventFlowSystemActor@Sub.WaitFrame(60)
            EventFlowSystemActor@Sub.ChangeCommuneDecoFortuneState('cFortuneTellingStart_Shine')
    EventFlowSystemActor.WaitFrame(20)
    if SubflowResults@4[3] not in (0, 1):
        EventFlowSystemActor.WaitCommuneDecoFortuneDisplayContentPreparation()
    EventFlowSystemActor.MessageLockNext(3)
    fork:
        branch:
            EventFlowSystemActor.WaitFrame(135)
            EventFlowSystemActor.MessageSuspend()
            EventFlowSystemActor.MessageUnlockNext()
        branch:
            MainNpc.NpcStartAS('BptADivine', false, true)
            MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:023', false)
        branch:
            EventFlowSystemActor@Sub.WaitFrame(60)
            run CrystalBall_Flash()
    EventFlowSystemActor.WaitFrame(30)
    if SubflowResults@4[3] in (0, 1):
        EventFlowSystemActor.WaitCommuneDecoFortuneDisplayContentPreparation()
        run CrystalBall_Reflect()
        EventFlowSystemActor.WaitFrame(75)
        MainNpc.CharacterEmoticonAction('EmotEnd', false, '', 0, false)
        EventFlowSystemActor.WaitFrame(0)
        fork:
            branch:
                MainNpc.OpenMessageWindow('TalkSNpc/bpt/SP_bpt_02_Commune:024', false)
            branch:
                Player.PlayerChangeStateDemoTalk()

flow CrystalBall_Flash():
    switch SubflowResults@Sub@4[3]:
        case 0, 1:
            EventFlowSystemActor@Sub.ChangeCommuneDecoFortuneState('cFortuneTelling_ShineStrongly')
        case 2:
            EventFlowSystemActor@Sub.ChangeCommuneDecoFortuneState('cFortuneTelling_ShineStrongly_Purification')
        case 3:
            EventFlowSystemActor@Sub.ChangeCommuneDecoFortuneState('cFortuneTelling_ShineStrongly_Pray')

flow CrystalBall_Reflect():
    switch SubflowResults@4[3]:
        case 0:
            switch MainNpc.FortuneBranchPre():
                case 0, 1:
                    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTelling_SomethingIsReflected_MoneyLuck')
                case 2, 3:
                    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTelling_SomethingIsReflected_FriendshipLuck')
                case 4, 5:
                    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTelling_SomethingIsReflected_ItemLuck')
                case 6, 7:
                    EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTelling_SomethingIsReflected_HealthyLuck')
        case 1:
            EventFlowSystemActor.ChangeCommuneDecoFortuneState('cFortuneTelling_SomethingIsReflected_Affinity')
        default:
            return

