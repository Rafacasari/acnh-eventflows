flow PknMeorizeItem():
    switch EventFlowSystemActor.FlagSystemIntValue8(8, 'cPlayer:PknGetItem'):
        case 0:
            System.EventFlags['cPlayer:GetHalloweenMask'] = true
        case 1:
            System.EventFlags['cPlayer:GetHalloweenRobe'] = true
        case 2:
            System.EventFlags['cPlayer:PknGetCarriageFlag'] = true
        case 3:
            System.EventFlags['cPlayer:PknGetCarriageRecipeFlag'] = true
        case 4, 7:
            System.EventFlags['cPlayer:GetHalloweenStickRecipe'] = true
        default:
            return

flow Pkn_1stCandy():
    if EventFlowSystemActor.HasTargetItem(13197, 1):
        if EventFlowSystemActor.IsMyVillage():
            if System.EventFlags['cPlayer:PknTalkLastNoCandyFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:011', false)
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:007', false)
        else:
            if System.EventFlags['cPlayer:PknTalkLastNoCandyFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:011', false)
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:007', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run Pkn_GiveEatCandy()
            run Pkn_GetItem()
        else:
            run Pkn_Trick()
    else:
        if EventFlowSystemActor.IsMyVillage():
            System.EventFlags['cPlayer:PknTalkLastNoCandyFlag'] = true
        else:
            System.EventFlags['cPlayerVisit:DC_PknTalkLastNoCandyFlag'] = true
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:008', false)
        EventFlowSystemActor.ExitFlowchart()

flow Pkn_CandyComp():
    if not EventFlowSystemActor.PercentChoice(70):
        if EventFlowSystemActor.RandomChoiceExcludePrevious2(2, true) == 0:
            EventFlowSystemActor.SelectRewardItemDirect(12987, 1, 'cVillageRemakePattern', 0)
            System.EventFlags['cPlayer:PknGetItem'] = 1
        else:
            EventFlowSystemActor.SelectRewardItemDirect(13002, 1, 'cVillageRemakePattern', 0)
            System.EventFlags['cPlayer:PknGetItem'] = 0
    elif EventFlowSystemActor.RandomChoice2(2) == 0:
        switch EventFlowSystemActor.RandomChoice3(3):
            case 0:
                if Player.PlayerHaveGetColorSquash('cGreen'):
                    EventFlowSystemActor.SelectRewardItemDirect(4527, 5, 'cVillageRemakePattern', 0)
                    System.EventFlags['cPlayer:PknGetItem'] = 6
                else:
                    run Sub_Event77()
            case 1:
                if Player.PlayerHaveGetColorSquash('cYellow'):
                    EventFlowSystemActor.SelectRewardItemDirect(4526, 5, 'cVillageRemakePattern', 0)
                    System.EventFlags['cPlayer:PknGetItem'] = 6
                else:
                    run Sub_Event77()
            case 2:
                if Player.PlayerHaveGetColorSquash('cWhite'):
                    EventFlowSystemActor.SelectRewardItemDirect(4528, 5, 'cVillageRemakePattern', 0)
                    System.EventFlags['cPlayer:PknGetItem'] = 6
                else:
                    run Sub_Event77()
    else:
        run Sub_Event77()

flow Pkn_CandyNotComp():
    if System.EventFlags['cPlayer:GetHalloweenRobe']:
        if System.EventFlags['cPlayer:GetHalloweenMask']:
            run Pkn_CandyComp()
        else:
            run Sub_Event178()
    else:
        if (not System.EventFlags['cPlayer:GetHalloweenMask']) and (EventFlowSystemActor.RandomChoice2(2) != 0):
            run Sub_Event178()
        else:
            EventFlowSystemActor.SelectRewardItemDirect(12987, 1, 'cVillageRemakePattern', 0)
            System.EventFlags['cPlayer:PknGetItem'] = 1

flow Pkn_ChkCandyComp():
    if (System.EventFlags['cPlayer:GetHalloweenRobe']) and (System.EventFlags['cPlayer:GetHalloweenMask']):
        System.EventFlags['cPlayer:PknCompItemCandyFlag'] = true

flow Pkn_ChkRollipopComp():
    if (System.EventFlags['cPlayer:PknGiveLollipopCount'] > 2) and (System.EventFlags['cPlayer:PknGetCarriageFlag']) and (System.EventFlags['cPlayer:GetHalloweenStickRecipe']) and (System.EventFlags['cPlayer:GetHalloweenRobe']) and (System.EventFlags['cPlayer:GetHalloweenMask']):
        System.EventFlags['cPlayer:PknCompItemLollipopFlag'] = true

flow Pkn_GetItem():
    run Pkn_SetItem()
    if EventFlowSystemActor.ShoppingCapacity('cReward', 65534):
        if EventFlowSystemActor.IsMyVillage():
            if System.EventFlags['cPlayer:PknTalkLastNotGetFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:059', false)
        else:
            if System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:059', false)
        if EventFlowSystemActor.IsMyVillage():
            System.EventFlags['cPlayer:PknTalkLastNotGetFlag'] = false
            System.EventFlags['cPlayer:PknLastGiveCandyFlag'] = false
        else:
            System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag'] = false
            System.EventFlags['cPlayerVisit:DC_PknLastGiveCandyFlag'] = false
        MainNpc.SetDeliveryItem(1, true)
        MainNpc.SetItemName(1, 0, 0)
        if SubflowResults@2[0] == 0:
            run PknMeorizeItem()
            run Pkn_ChkCandyComp()
            switch EventFlowSystemActor.FlagSystemIntValue8(8, 'cPlayer:PknGetItem'):
                case 0, 1, 2, 3, 4, 7:
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:052', true)
                case 5:
                    EventFlowSystemActor.SetTagFromSystem('cFlow', 'cDegit', 0, 10, '')
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:053', true)
                case 6:
                    EventFlowSystemActor.SetTagFromSystem('cFlow', 'cDegit', 0, 5, '')
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:053', true)
            MainNpc.NpcDelivery(1, 'Default')
            if System.EventFlags['cPlayer:PknGiveCandyCount'] != 1:
                if (System.EventFlags['cPlayer:PknCompItemCandyFlag']) and (not System.EventFlags['cPlayer:PknCompItemLollipopFlag']):
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_05', false)
                else:
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_04', false)
                run Pkn_TerrifyReaction()
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_01', false)
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_02', false)
                if not System.EventFlags['cPlayer:PknCompItemCandyFlag']:
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_03', false)
                run Pkn_TerrifyReaction()
        else:
            EventFlowSystemActor.MessageSuspend()
            MainNpc.NpcDelivery(1, 'Default')
            run PknMeorizeItem()
            run Pkn_ChkRollipopComp()
            switch EventFlowSystemActor.FlagSystemIntValue8(8, 'cPlayer:PknGetItem'):
                case 0, 1, 7:
                    if System.EventFlags['cPlayer:PknCompItemLollipopFlag']:
                        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:057_03', false)
                        run Pkn_TerrifyReaction()
                    else:
                        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:057_02', false)
                        run Pkn_TerrifyReaction()
                case 2:
                    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:057_01', false)
                    run Pkn_TerrifyReaction()
                case 3, 4:
                    if System.EventFlags['cPlayer:PknCompItemLollipopFlag']:
                        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:057_03_01', false)
                        run Pkn_TerrifyReaction()
                    else:
                        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:057_02_01', false)
                        run Pkn_TerrifyReaction()
                default:
                    return
    else:
        if EventFlowSystemActor.IsMyVillage():
            if System.EventFlags['cPlayer:PknTalkLastNotGetFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:060', false)
            else:
                System.EventFlags['cPlayer:PknTalkLastNotGetFlag'] = true
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:058', false)
        else:
            if System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:060', false)
            else:
                System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag'] = true
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:058', false)
        if SubflowResults@2[0] == 0:
            if EventFlowSystemActor.IsMyVillage():
                System.EventFlags['cPlayer:PknLastGiveCandyFlag'] = true
            else:
                System.EventFlags['cPlayerVisit:DC_PknLastGiveCandyFlag'] = true
            EventFlowSystemActor.ExitFlowchart()
        else:
            EventFlowSystemActor.ExitFlowchart()

flow Pkn_GiveEatCandy():
    MainNpc.MessageSuspend()
    if System.EventFlags['cPlayer:PknGiveCandyCount'] != 0:
        EventFlowSystemActor.UIItemSelectWindowHandling('cItemKind', 65534, 'Candy', '', '', false)
        if EventFlowSystemActor.UIResultMenuDecide():
            if EventFlowSystemActor.MultiItemSelectInclude(13197, 65534, 65534, 65534, 65534, 65534, 65534, 65534, 'cItemSelect'):
                SubflowResults[0] = 0
            else:
                SubflowResults[0] = 1
            MainNpc.SetDeliveryItem(4, false)
            MainNpc.NpcDelivery(0, 'Keep')
            EventFlowSystemActor.SystemDeletePlayerItem('cItemWindowSub', 1)
            run Sub_grp_Event226()
        else:
            run Pkn_Trick()
    else:
        SubflowResults[0] = 0
        MainNpc.SetDeliveryItemAtRandom(13197, false, 'cVillageRemakePattern', 0)
        MainNpc.NpcDelivery(0, 'Keep')
        EventFlowSystemActor.DeleteTargetItem(13197, 1, true)
        run Sub_grp_Event226()

flow Pkn_RollipopComp():
    if EventFlowSystemActor.RandomChoice2(2) == 0:
        EventFlowSystemActor.SelectRewardItemDirect(12987, 1, 'cVillageRemakePattern', 0)
        System.EventFlags['cPlayer:PknGetItem'] = 1
    else:
        EventFlowSystemActor.SelectRewardItemDirect(13002, 1, 'cVillageRemakePattern', 0)
        System.EventFlags['cPlayer:PknGetItem'] = 0

flow Pkn_RollipopNotComp():
    if not System.EventFlags['cPlayer:PknGetCarriageFlag']:
        EventFlowSystemActor.SelectRewardItemDirect(4087, 1, 'cVillageRemakePattern', 0)
        System.EventFlags['cPlayer:PknGetItem'] = 2
    elif (not EventFlowSystemActor.PlayerHasCraftRecipe('', 4087)) and (not System.EventFlags['cPlayer:PknGetCarriageRecipeFlag']):
        EventFlowSystemActor.NpcSetRewardRecipe(4087, false)
        System.EventFlags['cPlayer:PknGetItem'] = 3
    elif System.EventFlags['cPlayer:GetHalloweenStickRecipe']:
        if System.EventFlags['cPlayer:PknCompItemCandyFlag']:
            run Pkn_RollipopComp()
        else:
            run Pkn_CandyNotComp()
    else:
        if EventFlowSystemActor.PlayerHasCraftRecipe('Halloween', 13237):
            EventFlowSystemActor.SelectRewardItemDirect(13237, 1, 'cVillageRemakePattern', 0)
            System.EventFlags['cPlayer:PknGetItem'] = 7
        else:
            EventFlowSystemActor.NpcSetRewardRecipe(13237, false)
            System.EventFlags['cPlayer:PknGetItem'] = 4
        EventFlowSystemActor.SetMemoryEventPlayer('cBlancoEventPlayer:PE_Halloween_GetRecipe')

flow Pkn_SetItem():
    if EventFlowSystemActor.IsMyVillage():
        if System.EventFlags['cPlayer:PknTalkLastNotGetFlag']:
            if System.EventFlags['cPlayer:PknLastGiveCandyFlag']:
                SubflowResults[0] = 0
            else:
                SubflowResults[0] = 1
    else:
        if System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag']:
            if System.EventFlags['cPlayerVisit:DC_PknLastGiveCandyFlag']:
                SubflowResults[0] = 0
            else:
                SubflowResults[0] = 1
    if SubflowResults@2[0] == 0:
        if System.EventFlags['cPlayer:PknCompItemCandyFlag']:
            run Pkn_CandyComp()
        else:
            run Pkn_CandyNotComp()
    elif System.EventFlags['cPlayer:PknCompItemLollipopFlag']:
        run Pkn_RollipopComp()
    else:
        run Pkn_RollipopNotComp()

flow Pkn_TerrifyReaction():
    if not Player.PlayerHaveNewReaction('cScaring'):
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:040', false)
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:041', false)
        if not System.EventFlags['cPlayer:EnableEmoticonUI']:
            System.EventFlags['cPlayer:EnableEmoticonUI'] = true
            System.EventFlags['cPlayer:EnabledEmoticonIrregular'] = true
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:042', false)
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:043', false)
        MainNpc.GetAddEmoticon('AddScaring')
        EventFlowSystemActor.ReservePlayerMutterDemo('Player_GetDemo_Emoticons', 'Get_Emoticon', 'cNowDemoEnd', true)

flow Pkn_Trick():
    if EventFlowSystemActor.RandomChoice2(2) == 0:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:061', true)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:062', true)
    fork:
        branch:
            Player.PlayerHalloweenTricked()
        branch:
            MainNpc.NpcStartAS('PknPrank', true, true)
    if System.EventFlags['cPlayer:PknGiveCandyCount'] != 0:
        if EventFlowSystemActor.RandomChoice2(2) == 0:
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:064', false)
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:063', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:063_01', false)
    if not System.EventFlags['cPlayer:NpcHalloweenTrickFlag']:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:065', false)
        System.EventFlags['cPlayer:NpcHalloweenTrickFlag'] = true
    if EventFlowSystemActor.IsMyVillage():
        System.EventFlags['cPlayer:PknTalkLastNoCandyFlag'] = false
    else:
        System.EventFlags['cPlayerVisit:DC_PknTalkLastNoCandyFlag'] = false
    EventFlowSystemActor.ExitFlowchart()

flow Root():
    if EventFlowSystemActor.EnvHourCompare(0, 0, true, true) != 0:
        switch EventFlowSystemActor.RandomChoiceExcludePrevious3(3, true):
            case 0:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:030', false)
            case 1:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:031', false)
            case 2:
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:032', false)
    elif EventFlowSystemActor.IsMyVillage():
        if System.EventFlags['cPlayer:PknTalkTodayFlag']:
            run Sub_grp_Event167()
        else:
            System.EventFlags['cPlayer:PknTalkTodayFlag'] = true
            System.EventFlags['cPlayer:PknTalkBeforeFlag'] = true
            run Sub_Event1()
    else:
        if System.EventFlags['cPlayerVisit:DC_PknTalkTodayFlag']:
            run Sub_grp_Event167()
        else:
            System.EventFlags['cPlayerVisit:DC_PknTalkTodayFlag'] = true
            run Sub_Event1()

local flow Sub_Event1():
    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:001', false)
    if EventFlowSystemActor.PlayerIsEquipItem(12987, 13002, 65534, 65534, 65534, 65534, 65534, 65534, 'cAll', false, true):
        if EventFlowSystemActor.IsMyVillage():
            if not System.EventFlags['cPlayer:PknPumpkingLookChatFlag']:
                System.EventFlags['cPlayer:PknPumpkingLookChatFlag'] = true
                MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:033', false)
        elif not System.EventFlags['cPlayerVisit:DC_PknPumpkingLookChatFlag']:
            System.EventFlags['cPlayerVisit:DC_PknPumpkingLookChatFlag'] = true
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:033', false)
    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:002', false)
    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:003', false)
        run Sub_Event105()
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:004', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:005', false)
            run Sub_Event105()
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:006', false)
            run Pkn_1stCandy()

local flow Sub_Event105():
    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:003_01', false)
    run Pkn_1stCandy()

local flow Sub_Event166():
    MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:033', false)
    EventFlowSystemActor.ExitFlowchart()

local flow Sub_Event178():
    EventFlowSystemActor.SelectRewardItemDirect(13002, 1, 'cVillageRemakePattern', 0)
    System.EventFlags['cPlayer:PknGetItem'] = 0

local flow Sub_Event77():
    EventFlowSystemActor.SelectRewardItemDirect(4525, 10, 'cVillageRemakePattern', 0)
    System.EventFlags['cPlayer:PknGetItem'] = 5

local flow Sub_grp_Event148():
    if EventFlowSystemActor.HasKindItem('', 'Candy', ''):
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:020', false)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run Pkn_GiveEatCandy()
            run Pkn_GetItem()
        else:
            run Pkn_Trick()
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_02', false)
        if not System.EventFlags['cPlayer:PknCompItemCandyFlag']:
            MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:054_03', false)

local flow Sub_grp_Event167():
    if EventFlowSystemActor.PlayerIsEquipItem(12987, 13002, 65534, 65534, 65534, 65534, 65534, 65534, 'cAll', false, true):
        if EventFlowSystemActor.IsMyVillage():
            if System.EventFlags['cPlayer:PknPumpkingLookChatFlag']:
                run Sub_grp_Event40()
            else:
                System.EventFlags['cPlayer:PknPumpkingLookChatFlag'] = true
                run Sub_Event166()
        else:
            if System.EventFlags['cPlayerVisit:DC_PknPumpkingLookChatFlag']:
                run Sub_grp_Event40()
            else:
                System.EventFlags['cPlayerVisit:DC_PknPumpkingLookChatFlag'] = true
                run Sub_Event166()
    else:
        run Sub_grp_Event40()

local flow Sub_grp_Event226():
    if EventFlowSystemActor.IsMyVillage():
        System.EventFlags['cPlayer:PknTalkLastNoCandyFlag'] = false
    else:
        System.EventFlags['cPlayerVisit:DC_PknTalkLastNoCandyFlag'] = false
    if SubflowResults@2[0] == 0:
        System.EventFlags['cPlayer:PknGiveCandyCount'] += 1
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:050', true)
    else:
        System.EventFlags['cPlayer:PknGiveLollipopCount'] += 1
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:055', true)
    MainNpc.NpcDelivery(12, 'Default')
    if SubflowResults@2[0] == 0:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:051', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/pkn/SP_pkn:056', false)

local flow Sub_grp_Event40():
    if System.EventFlags['cPlayer:PknGiveCandyCount'] < 1:
        run Pkn_1stCandy()
    elif EventFlowSystemActor.IsMyVillage():
        if System.EventFlags['cPlayer:PknTalkLastNotGetFlag']:
            run Pkn_GetItem()
        else:
            run Sub_grp_Event148()
    else:
        if System.EventFlags['cPlayerVisit:DC_PknTalkLastNotGetFlag']:
            run Pkn_GetItem()
        else:
            run Sub_grp_Event148()

